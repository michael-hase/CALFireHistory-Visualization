<!DOCTYPE html >
<html lang="en">
  <head>
      <meta charset="utf-8" />
      <title>mapboxgl.js + d3.js tutorial - 04</title>
      <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
      <link rel='stylesheet' href='css/mapbox-gl.css' type='text/css' />
      <script src="js/mapbox-gl.js"></script>
      <!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
      <script src="js/d3.v7.min.js" charset="utf-8"></script>

      <style media="screen">
          body { margin:0; padding:0; }
          #map { position:absolute; top:0; bottom:0; width:100%; }

          svg {
            position: absolute;
            width: 100%;
            height: 100%;
          }

          path {
              fill: #e55e5e;
              stroke: #e55e5e;
              stroke-width: 2;
              fill-opacity: 0.6;
          }

      </style>
  </head>
  <body>
    <div id="map">
    </div>
    <script>

        //////////////////
        // Mapbox stuff
        //////////////////

        // Set-up map
    	mapboxgl.accessToken = "pk.eyJ1IjoibWhhc2UiLCJhIjoiY2xwbGlhaTlzMDBjMjJpcGpmOTV2bm81bSJ9.3zM0OFHwRTg8fDdz8kmAfg";
      var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/outdoors-v9',
        zoom:5.1,
        center: [-120, 37.8],
      });


        //////////////////////////
        // Mapbox+D3 Connection
        //////////////////////////

        // Get Mapbox map canvas container
        var canvas = map.getCanvasContainer();

        // Overlay d3 on the map
        var svg = d3.select(canvas).append("svg");

        // Projection functions
        const transform = d3.geoTransform({point: projectPoint});
          const path = d3.geoPath().projection(transform);

        function project(d) {
              return map.project(new mapboxgl.LngLat(+d[0], +d[1]));
            }

            // Project any point (lon, lat) to map's current state
        function projectPoint(lon, lat) {
          var point = map.project(new mapboxgl.LngLat(lon, lat));
          this.stream.point(point.x, point.y);
        }
        // Load map and dataset
        map.on('load', function(){
          const yearsData = {
            '2017': 'data/Updated_FirePerimeters_2017.geojson',
            '2018': 'data/Updated_FirePerimeters_2018.geojson',
            '2019': 'data/Updated_FirePerimeters_2019.geojson',
            '2020': 'data/Updated_FirePerimeters_2020.geojson',
            '2021': 'data/Updated_FirePerimeters_2021.geojson',
            '2022': 'data/Updated_FirePerimeters_2022.geojson',
          };

// Add the drought data source and layer (from Script 1)
          map.addSource('drought-data', {
            'type': 'geojson',
            'data': '', // Initial data is empty, you'll update it using loadDroughtGeoJSON
          });

          map.addLayer({
            'id': 'drought-layer',
            'type': 'fill',
            'source': 'drought-data',
            'paint': {
              'fill-color': [
                'case',
                ['has', 'fill'], // Check if the "fill" property exists
                ['get', 'fill'], // Use the "fill" property if it exists
                '#ffffff' // Default fill color if "fill" property is missing or null
              ],
              'fill-opacity': 0.3
            }
          });

// Use D3 to load GeoJSON data for each year
          for (const year in yearsData) {
            d3.json(yearsData[year], function(error, data) {
              if (error) throw error;

              // Add the GeoJSON data as a layer on the map
              map.addSource(`fire-source-${year}`, {
                'type': 'geojson',
                'data': data
              });

              map.addLayer({
                'id': `fire-layer-${year}`,
                'type': 'fill',
                'source': `fire-source-${year}`,
                'layout': {
                  'visibility': 'none' // initially set to 'none'
                },
                'paint': {
                  'fill-color': [
                    'case',
                    ['has', 'fill'], // Check if the "fill" property exists
                    ['get', 'fill'], // Use the "fill" property if it exists
                    '#ffffff' // Default fill color if "fill" property is missing or null
                  ],
                  'fill-opacity': 0.8
                }
              });
            });

          }

        })

    </script>
  </body>
</html>

